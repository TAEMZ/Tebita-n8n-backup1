{
  "createdAt": "2025-04-25T19:09:12.117Z",
  "updatedAt": "2025-04-26T17:04:35.795Z",
  "id": "YOZB3R2Wge7SKCad",
  "name": "Content Creator - Blogpost Trigger",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "<script>window.close()</script>",
        "options": {}
      },
      "id": "6e17d00e-6995-4df0-8bd5-7fc1b663b828",
      "name": "Respond 200",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -1360,
        80
      ]
    },
    {
      "parameters": {
        "url": "=https://api.airtable.com/v0/{{ $('Webhook').item.json.query.base_id }}/{{ $('Webhook').item.json.query.table_id }}/{{ $('Webhook').item.json.query.record_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "id": "0bcef9ee-939b-4c26-af9e-78c625f9134e",
      "name": "GET Airtable Record",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1140,
        80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "5QC5eN6T4Ff5GA8C",
          "name": "Airtable for The Human Code"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.airtable.com/v0/{{ $('Webhook').item.json.query.base_id }}/{{ $('Webhook').item.json.query.table_id }}/{{ $('Webhook').item.json.query.record_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"fields\": {\n    \"AI Status\": \"AI Writing...\"\n  }\n}",
        "options": {}
      },
      "id": "ced7c865-2847-4a42-8fe2-72fd703b3e65",
      "name": "Set Record Status to AI Writing (Airtable)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -940,
        80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "5QC5eN6T4Ff5GA8C",
          "name": "Airtable for The Human Code"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// This code should be placed in an n8n Function node.\n\n// Process all input items\nconst output = items.map(item => {\n  // Get the setOutline field from the current item\n  const SetOutline = item.json.SetOutline;\n\n  // Ensure SetOutline exists and is valid\n  if (!SetOutline) {\n    throw new Error(\"SetOutline field is missing or undefined in one of the items.\");\n  }\n\n  // Replace real line breaks with the visible \\n character\n  const formattedOutput = SetOutline\n    .replace(/\\n/g, \"\\\\n\") // Replace real line breaks with visible \\n\n    .replace(/\"/g, '\\\\\"'); // Escape double quotes\n\n  // Return the formatted output for the current item\n  return {\n    json: {\n      outlineOutput: formattedOutput\n    }\n  };\n});\n\n// Return all processed items\nreturn output;\n"
      },
      "id": "b1324e36-8efc-4864-a025-38825b2ff5ad",
      "name": "Convert SetOutline into JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -560,
        80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n   \"n\":\"1\",\n   \"model\":\"{{ $('GET Airtable Record').item.json.fields['AI Model (Plain Text) (from AI Models)'][0] }}\",\n   \"top_p\":1,\n   \"fallback\":true,\n   \"messages\":[\n      {\n         \"role\":\"user\",\n         \"content\":\"{{ $json.outlineOutput }}\"\n      }\n   ],\n   \"json_mode\":true,\n   \"max_tokens\":{{ $('GET Airtable Record').item.json.fields['Max Tokens (from AI Models)'][0] }},\n   \"temperature\":{{ $('GET Airtable Record').item.json.fields['Temperature (from AI Models)'][0] }}\n}",
        "options": {}
      },
      "id": "289c1839-d838-4b8f-a1a4-5bdad8f45856",
      "name": "Outline Prompt",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -380,
        80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "MoOzBggpmmvQVB88",
          "name": "klap"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// This code should be placed in an n8n Function node.\n\n// Process all input items\nconst output = items.map(item => {\n  // Access the message content within choices array\n  const messageContent = item.json.choices[0]?.message?.content;\n\n  // Ensure message content exists and is valid\n  if (!messageContent) {\n    throw new Error(\"message.content field is missing or undefined in one of the items.\");\n  }\n\n  // Replace real line breaks with the visible \\n character\n  const formattedOutput = messageContent\n    .replace(/\\n/g, \"\\\\n\") // Replace real line breaks with visible \\n\n    .replace(/\"/g, '\\\\\"'); // Escape double quotes\n\n  // Return the formatted output for the current item\n  return {\n    json: {\n      outlineJson: formattedOutput\n    }\n  };\n});\n\n// Return all processed items\nreturn output;\n"
      },
      "id": "9d2b5f36-33bd-4ec4-aa7a-6e1920c5920e",
      "name": "Convert Outline Output into JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -180,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "// Access the 'outlineJson' field from the input item\nconst outlineJson = $json.outlineJson || \"\";\n\n// Split the outlineJson content into lines\nconst lines = outlineJson.split(/\\\\n/);\n\n// Initialize variables for grouping\nlet currentSection = null;\nconst sections = [];\n\n// Iterate through the lines and group by sections\nlines.forEach((line) => {\n  const trimmedLine = line.trim();\n\n  if (trimmedLine.startsWith(\"##\")) {\n    // Start a new section\n    if (currentSection) {\n      sections.push(currentSection);\n    }\n    currentSection = trimmedLine; // Initialize the new section with the title\n  } else if (currentSection && trimmedLine) {\n    // Append the point to the current section\n    currentSection += \"\\n\" + trimmedLine;\n  }\n});\n\n// Add the last section if it exists\nif (currentSection) {\n  sections.push(currentSection);\n}\n\n// Create individual outputs for each merged section\nreturn sections.map((section) => ({\n  json: {\n    mergedSection: section,\n  },\n}));\n"
      },
      "id": "d4707e41-b32e-43af-ba07-d0f0fad41337",
      "name": "Segregate sections",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        40,
        80
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "167f3ee1-cb22-4885-81a5-3f08b8405248",
              "name": "sectionPrompt",
              "value": "=###Brand Details###\nBrand voice: {{ $('GET Airtable Record').item.json.fields['Brand Voice Guidelines (from Brand Assets)'][0] }}.\nExclude these words & phrases: {{ $('GET Airtable Record').item.json.fields['Excluded Words & Phrases (from Brand Assets)'][0] }}.\nWrite at a {{ $('GET Airtable Record').item.json.fields['Writing Grade Level (from Brand Assets)'][0] }} grade level.\n\n###Context###\nBlogpost Title: {{ $('GET Airtable Record').item.json.fields['Blogpost Title'] }}.\nBlogpost Type: {{ $('GET Airtable Record').item.json.fields['packagedTemplatePromptText Rollup (from Prompt Library)'] }}.\nTranscript: {{ $('GET Airtable Record').item.json.fields['Transcript Or Context (All Workflows) CLEANED'] }}.\n\n###Instruction###\nWrite an award winning article. Your task is to write one section and one section only.\nYour output should be in {{ $('GET Airtable Record').item.json.fields['Language (from Brand Assets)'][0] }} language.\n---\n{{ $json.mergedSection }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "2db7798d-6fa5-4368-afd5-d4d36a0da252",
      "name": "Set Section Prompt",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        240,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "// This code should be placed in an n8n Function node.\n\n// Process all input items\nconst output = items.map(item => {\n  // Get the setOutline field from the current item\n  const sectionPrompt = item.json.sectionPrompt;\n\n  // Ensure sectionPrompt exists and is valid\n  if (!sectionPrompt) {\n    throw new Error(\"SetOutline field is missing or undefined in one of the items.\");\n  }\n\n  // Replace real line breaks with the visible \\n character\n  const formattedOutput = sectionPrompt\n    .replace(/\\n/g, \"\\\\n\") // Replace real line breaks with visible \\n\n    .replace(/\"/g, '\\\\\"'); // Escape double quotes\n\n  // Return the formatted output for the current item\n  return {\n    json: {\n      sectionPromptJson: formattedOutput\n    }\n  };\n});\n\n// Return all processed items\nreturn output;\n"
      },
      "id": "88b977c4-23d0-440a-aa9a-6d2db081d7da",
      "name": "Convert Section Prompt into JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n   \"n\":\"1\",\n   \"model\":\"{{ $('GET Airtable Record').item.json.fields['AI Model (Plain Text) (from AI Models)'][0] }}\",\n   \"top_p\":1,\n   \"fallback\":true,\n   \"messages\":[\n      {\n         \"role\":\"user\",\n         \"content\":\"{{ $json.sectionPromptJson }}\"\n      }\n   ],\n   \"json_mode\":true,\n   \"max_tokens\":{{ $('GET Airtable Record').item.json.fields['Max Tokens (from AI Models)'][0] }},\n   \"temperature\":{{ $('GET Airtable Record').item.json.fields['Temperature (from AI Models)'][0] }}\n}",
        "options": {}
      },
      "id": "7c425fb0-ba71-412e-8dfc-7f4c5e373a81",
      "name": "Section Prompt",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        680,
        80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "MoOzBggpmmvQVB88",
          "name": "klap"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process all input items\nconst output = items\n  .filter(item => {\n    const messageContent = item.json.choices[0]?.message?.content;\n    return typeof messageContent === 'string' && messageContent.trim() !== '';\n  })\n  .map(item => {\n    const messageContent = item.json.choices[0].message.content;\n\n    // Replace real line breaks with the visible \\n character and escape double quotes\n    const formattedOutput = messageContent\n      .replace(/\\n/g, \"\\\\n\") // Replace real line breaks with visible \\n\n      .replace(/\"/g, '\\\\\"'); // Escape double quotes\n\n    // Return the formatted output for the current item\n    return {\n      json: {\n        sectionOutputJson: formattedOutput\n      }\n    };\n  });\n\n// Return all processed items\nreturn output;"
      },
      "id": "54897711-8633-4886-8d6a-07097489b3e4",
      "name": "Convert Section Prompt output into JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        80
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "167f3ee1-cb22-4885-81a5-3f08b8405248",
              "name": "SetOutline",
              "value": "=###Context###\nTitle: {{ $json.fields['Content Title (ID)'] }}.\nPrimaryKeyword: {{ $json.fields['SEO Keyword(s)'] }}.\nInternal Links: {{ $json.fields['Blogpost Internal Links'] }}.\nExternalLinks: {{ $json.fields['Blogpost External Links'] }}.\nMore context about article: {{ $json.fields['Transcript Or Context (All Workflows) CLEANED'] }}.\nBlogpost Type: {{ $json.fields['packagedTemplatePromptText Rollup (from Prompt Library)'] }}\n\n###Instruction###\nYour task is to prepare an article outline for the context provided.\nYour output should be in {{ $json.fields['Language (from Brand Assets)'][0] }} language. Your output must be written in Markdown format (atx). Remember, this is just an outline, you should add bulletpoints of what to cover in each section, not write the section. The headline must begin with #, but then ensure each of the other sections begin with ##, instead of just #",
              "type": "string"
            },
            {
              "id": "f045a2fc-3fc5-4fb6-b1a5-052d86f4cf32",
              "name": "base_id",
              "value": "={{ $('Webhook').item.json.query.base_id }}",
              "type": "string"
            },
            {
              "id": "5ca43b05-002b-407d-9f4c-8e1dec61679a",
              "name": "table_id",
              "value": "={{ $('Webhook').item.json.query.table_id }}",
              "type": "string"
            },
            {
              "id": "1a23949a-dcd9-44fd-8433-26472871e0a7",
              "name": "record_id",
              "value": "={{ $('Webhook').item.json.query.record_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "979ce4c4-03a0-43ce-aef9-8d369d6a8e4c",
      "name": "Set Outline and Airtable IDs",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -740,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "// Initialize an array to collect all 'sectionOutputJson' fields\nlet mergedContents = [];\n\n// Iterate through all input items and collect 'sectionOutputJson'\n$input.all().forEach(item => {\n  const sectionOutputJson = item.json.sectionOutputJson || '';\n  if (sectionOutputJson) {\n    mergedContents.push(sectionOutputJson);\n  }\n});\n\n// Combine all collected 'sectionOutputJson' into one string\nconst mergedContent = mergedContents.join('\\n\\n');\n\n// Access fields from the 'Set Outline and Airtable IDs' node safely\nconst base_id = $('Set Outline and Airtable IDs').first().json.base_id || '';\nconst table_id = $('Set Outline and Airtable IDs').first().json.table_id || '';\nconst record_id = $('Set Outline and Airtable IDs').first().json.record_id || '';\n\n// Return the merged content and additional fields as a single item\nreturn [\n  {\n    json: {\n      mergedSectionOutputJson: mergedContent,\n      base_id: base_id,\n      table_id: table_id,\n      record_id: record_id\n    }\n  }\n];"
      },
      "id": "4bda000a-0328-4734-83f7-ef23ae8ca703",
      "name": "Aggregate Sections",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        80
      ]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.airtable.com/v0/{{ $json.base_id }}/{{ $json.table_id }}/{{ $json.record_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"fields\": {\n    \"AI Status\": \"AI Complete\",\n    \"Blogpost Final Version\": \"{{$json.mergedSectionOutputJson.replace(/\\n/g, '\\\\n')}}\"\n  }\n}",
        "options": {}
      },
      "id": "fee54bbb-c153-4a37-8f94-e704a9e8b09d",
      "name": "Update Record Status to AI Complete (Airtable)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1340,
        80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "5QC5eN6T4Ff5GA8C",
          "name": "Airtable for The Human Code"
        }
      }
    },
    {
      "parameters": {
        "path": "47ab64a9-1af2-4a9e-92c5-03d3fa6420c2",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "cb0b2453-d08b-451d-afe3-54fe88422a90",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1560,
        80
      ],
      "webhookId": "47ab64a9-1af2-4a9e-92c5-03d3fa6420c2"
    },
    {
      "parameters": {
        "content": "## Iteration for Section Prompts",
        "height": 258.51731860267483,
        "width": 1047.4794697489972,
        "color": 4
      },
      "id": "b67a056d-0c8f-4878-b959-6d528ba9e0b1",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ]
    }
  ],
  "connections": {
    "Respond 200": {
      "main": [
        [
          {
            "node": "GET Airtable Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Airtable Record": {
      "main": [
        [
          {
            "node": "Set Record Status to AI Writing (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Record Status to AI Writing (Airtable)": {
      "main": [
        [
          {
            "node": "Set Outline and Airtable IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert SetOutline into JSON": {
      "main": [
        [
          {
            "node": "Outline Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Outline Prompt": {
      "main": [
        [
          {
            "node": "Convert Outline Output into JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Outline Output into JSON": {
      "main": [
        [
          {
            "node": "Segregate sections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Segregate sections": {
      "main": [
        [
          {
            "node": "Set Section Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Section Prompt": {
      "main": [
        [
          {
            "node": "Convert Section Prompt into JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Section Prompt into JSON": {
      "main": [
        [
          {
            "node": "Section Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Section Prompt": {
      "main": [
        [
          {
            "node": "Convert Section Prompt output into JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Outline and Airtable IDs": {
      "main": [
        [
          {
            "node": "Convert SetOutline into JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Section Prompt output into JSON": {
      "main": [
        [
          {
            "node": "Aggregate Sections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Sections": {
      "main": [
        [
          {
            "node": "Update Record Status to AI Complete (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Respond 200",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "3dc85fd9-2fd1-4a76-8d1e-876ad37dab17",
  "triggerCount": 1,
  "tags": [],
  "shared": [
    {
      "createdAt": "2025-04-25T19:09:12.117Z",
      "updatedAt": "2025-04-25T19:09:12.117Z",
      "role": "workflow:owner",
      "workflowId": "YOZB3R2Wge7SKCad",
      "projectId": "IQ4w3zW02fJzIdTt",
      "project": {
        "createdAt": "2025-01-25T02:11:56.995Z",
        "updatedAt": "2025-01-25T21:11:21.957Z",
        "id": "IQ4w3zW02fJzIdTt",
        "name": "Yonatan Tesfaye <yonatantesfaye30@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null
      }
    }
  ]
}